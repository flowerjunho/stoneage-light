# 석기시대 2.5 전투 시스템 완전 가이드

> **분석 버전**: 신규 버전 (`_BATTLE_NEWPOWER` 활성화 기준)
> **소스 코드**: https://github.com/gavinlinasd/StoneAge

---

## 📖 목차

1. [캐릭터 능력치 시스템](#1-캐릭터-능력치-시스템)
2. [속성 시스템](#2-속성-시스템)
3. [전투 능력치 변환](#3-전투-능력치-변환)
4. [기본 데미지 계산](#4-기본-데미지-계산)
5. [속성 데미지 보정](#5-속성-데미지-보정)
6. [라이딩 펫 시스템](#6-라이딩-펫-시스템)
7. [완전한 데미지 공식](#7-완전한-데미지-공식)
8. [실전 예제](#8-실전-예제)
9. [최적화 전략](#9-최적화-전략)

---

## 1. 캐릭터 능력치 시스템

### 1.1 기본 능력치 (Primary Stats)

캐릭터 생성 시 설정하는 4가지 기본 능력치:

| 능력치 | 영문명 | 포인트 범위 | 저장 배율 | 주요 효과 |
|---|---|:---:|:---:|---|
| **체력** | VITAL (VIT) | 0~20pt | ×100 | HP, 방어력 보조 (구버전) |
| **공격력** | STRENGTH (STR) | 0~20pt | ×100 | 공격력 |
| **방어력** | TOUGHNESS (TGH) | 0~20pt | ×100 | 방어력 |
| **순발력** | DEXTERITY (DEX) | 0~20pt | ×100 | 순발력, 크리티컬 |

**제약 조건**:
- ✅ 총 합계: **정확히 20pt**
- ✅ 각 능력치: 0~20pt

```c
// 소스 코드: gmsv/char/char.c:133-136
ch->data[CHAR_VITAL] = vital * 100;  // 체력
ch->data[CHAR_STR]   = str * 100;    // 공격력
ch->data[CHAR_TOUGH] = tgh * 100;    // 방어력
ch->data[CHAR_DEX]   = dex * 100;    // 순발력
```

---

### 1.2 속성 포인트 (Elemental Attributes)

캐릭터 생성 시 설정하는 4가지 속성:

| 속성 | 기호 | 포인트 범위 | 저장 배율 |
|---|:---:|:---:|:---:|
| **지(地)** | 🌍 Earth | 0~10pt | ×10 |
| **수(水)** | 💧 Water | 0~10pt | ×10 |
| **화(火)** | 🔥 Fire | 0~10pt | ×10 |
| **풍(風)** | 💨 Wind | 0~10pt | ×10 |

**제약 조건**:
- ✅ 총 합계: **정확히 10pt**
- ✅ 최대 2개 속성만 선택 가능
- ❌ **대립 속성 동시 선택 불가**:
  - 지(地) ↔ 화(火)
  - 수(水) ↔ 풍(風)

```c
// 소스 코드: gmsv/char/char.c:138-141
ch->data[CHAR_EARTHAT] = earth * 10;  // 0~100
ch->data[CHAR_WATERAT] = water * 10;  // 0~100
ch->data[CHAR_FIREAT]  = fire * 10;   // 0~100
ch->data[CHAR_WINDAT]  = wind * 10;   // 0~100

// 대립 속성 체크: gmsv/char/char.c:127-128
if (earth > 0 && fire > 0) return FALSE;  // 지 & 화 동시 불가
if (water > 0 && wind > 0) return FALSE;  // 수 & 풍 동시 불가
```

---

## 2. 속성 시스템

### 2.1 속성 상성 구조

석기시대는 **순환 상성 구조**를 가집니다:

```
화(火) → 풍(風) → 지(地) → 수(水) → 화(火)
 ×1.5    ×1.5     ×1.5     ×1.5
```

**역순환 (불리한 상성)**:
```
화(火) ← 수(水) ← 지(地) ← 풍(風) ← 화(火)
 ×0.6    ×0.6     ×0.6     ×0.6
```

---

### 2.2 속성 상성표

| 공격 속성 ↓ \ 방어 속성 → | 🔥 화 | 💧 수 | 🌍 지 | 💨 풍 | 무속성 |
|---|:---:|:---:|:---:|:---:|:---:|
| **🔥 화** | 1.0 | **0.6** ⚠️ | 1.0 | **1.5** ✅ | 1.5 |
| **💧 수** | **1.5** ✅ | 1.0 | **0.6** ⚠️ | 1.0 | 1.5 |
| **🌍 지** | 1.0 | **1.5** ✅ | 1.0 | **0.6** ⚠️ | 1.5 |
| **💨 풍** | **0.6** ⚠️ | 1.0 | **1.5** ✅ | 1.0 | 1.5 |

```c
// 소스 코드: gmsv/battle/battle_event.c:25-28
#define AJ_SAME  (1.0)   // 동일 속성
#define AJ_UP    (1.5)   // 유리한 속성 (50% 증가)
#define AJ_DOWN  (0.6)   // 불리한 속성 (40% 감소)
```

**핵심 포인트**:
- ✅ **유리한 속성**: 데미지 ×1.5배 (50% 증가)
- ⚠️ **불리한 속성**: 데미지 ×0.6배 (40% 감소)
- ➖ **동일 속성**: 데미지 ×1.0배 (변화 없음)
- ✨ **무속성 상대**: 모든 속성 ×1.5배 유리

**최대/최소 차이**: 1.5 ÷ 0.6 = **2.5배**

---

## 3. 전투 능력치 변환

### 3.1 능력치 → 전투력 변환

전투 시작 시 기본 능력치가 전투 능력치로 변환됩니다:

```c
// 소스 코드: gmsv/battle/battle.c:2712-2727

// 1단계: 캐릭터 능력치 보정 (장비 등)
CHAR_complianceParameter(charaindex);

// 2단계: 공격력 계산
BATTLE_TurnParam(charaindex,
    CHAR_WORKFIXSTR,        // 보정된 STR
    CHAR_WORKMODATTACK,     // 공격력 수정치
    CHAR_WORKATTACKPOWER    // 최종 공격력
);

// 3단계: 방어력 계산
BATTLE_TurnParam(charaindex,
    CHAR_WORKFIXTOUGH,      // 보정된 TGH
    CHAR_WORKMODDEFENCE,    // 방어력 수정치
    CHAR_WORKDEFENCEPOWER   // 최종 방어력
);

// 4단계: 순발력 계산
BATTLE_TurnParam(charaindex,
    CHAR_WORKFIXDEX,        // 보정된 DEX
    CHAR_WORKMODQUICK,      // 순발력 수정치
    CHAR_WORKQUICK          // 최종 순발력
);
```

---

### 3.2 변환 공식

```c
// 소스 코드: gmsv/battle/battle.c:2624-2650

void BATTLE_TurnParam(int charaindex, int fixkind, int mod, int last) {
    fixparam = 기본_능력치;
    modparam = 수정치;

    // 수정치 80% 적용
    modparam *= 0.8;

    // 최종 능력치
    최종값 = 기본값 + (modparam * 0.01);
}
```

**해석**:
- 기본 능력치는 거의 그대로 사용
- 장비/버프 등의 수정치는 80%만 적용
- 수정치의 1%를 최종값에 추가 (미미한 영향)

---

### 3.3 방어력 계산 (신규 버전)

**비라이딩 시**:
```c
// 소스 코드: gmsv/battle/battle_event.c:1056
방어력 = TGH × 0.70
```

**구버전과의 차이**:
- **신규**: 방어력(TGH)만 70% 적용
- **구버전**: `TGH × 0.45 + DEX × 0.20 + VIT × 0.10`

---

## 4. 기본 데미지 계산

### 4.1 데미지 계산 3단계

공격력과 방어력의 비율에 따라 **3가지 케이스**로 나뉩니다:

```c
// 소스 코드: gmsv/battle/battle_event.c:1104-1114
```

---

#### 케이스 1: 공격력 ≥ 방어력 × 1.14

**조건**: `ATK ≥ DEF × (8/7)`

**공식**:
```
K0 = RAND(0, ATK × 0.125) - ATK × 0.0625
damage = (ATK - DEF) × DAMAGE_RATE + K0
```

**간단 계산**:
```
기본 데미지 = ATK - DEF
랜덤 변동 = ± ATK × 6.25%

최종 데미지 = (ATK - DEF) ± (ATK × 6.25%)
```

**예제**:
- ATK = 1500, DEF = 840
- 기본 = 1500 - 840 = 660
- 랜덤 = ±93.75
- **데미지 범위: 566 ~ 754**

---

#### 케이스 2: 방어력 ≤ 공격력 < 방어력 × 1.14

**조건**: `DEF ≤ ATK < DEF × (8/7)`

**공식**:
```
damage = RAND(0, ATK × 0.0625)
```

**간단 계산**:
```
데미지 = 0 ~ ATK × 6.25%
```

**예제**:
- ATK = 1000, DEF = 900
- **데미지 범위: 0 ~ 62**

---

#### 케이스 3: 공격력 < 방어력

**조건**: `ATK < DEF`

**공식**:
```
damage = RAND(0, 1)
```

**결과**: 0 또는 1 (거의 데미지 없음)

---

### 4.2 케이스 요약표

| 공격력 vs 방어력 비율 | 데미지 공식 | 특징 |
|---|---|---|
| **ATK < DEF** | 0 ~ 1 | 거의 무데미지 |
| **DEF ≤ ATK < DEF×1.14** | 0 ~ ATK×6.25% | 약한 데미지 |
| **ATK ≥ DEF×1.14** | (ATK-DEF) ± ATK×6.25% | 강한 데미지 |

**핵심 임계점**: 방어력의 **1.14배 (8/7)**

---

## 5. 속성 데미지 보정

### 5.1 속성 포인트 변환

캐릭터의 속성 포인트(0~10)는 0~100 범위로 변환됩니다:

```c
// 소스 코드: gmsv/battle/battle_event.c:849-852
속성값[지] = CHAR_WORKFIXEARTHAT;  // 0~100
속성값[수] = CHAR_WORKFIXWATERAT;  // 0~100
속성값[화] = CHAR_WORKFIXFIREAT;   // 0~100
속성값[풍] = CHAR_WORKFIXWINDAT;   // 0~100

// 무속성 계산
속성값[무] = 100 - (지 + 수 + 화 + 풍);
```

**예제**:
- 화 10pt → 속성값[화] = 100
- 속성값[무] = 100 - 100 = 0

---

### 5.2 속성 데미지 계산

```c
// 소스 코드: gmsv/battle/battle_event.c:809-841

// 화 속성 데미지
화_데미지 = 공격자_화 × 방어자_무 × 1.5
         + 공격자_화 × 방어자_화 × 1.0
         + 공격자_화 × 방어자_수 × 0.6
         + 공격자_화 × 방어자_지 × 1.0
         + 공격자_화 × 방어자_풍 × 1.5

// 다른 속성도 동일하게 계산...

// 최종 속성 보정
총합 = 화_데미지 + 수_데미지 + 지_데미지 + 풍_데미지 + 무_데미지
속성_보정 = 총합 × 0.0001
```

```c
// 소스 코드 상수
#define ATTR_MAX 100
#define D_ATTR (1.0/(ATTR_MAX*ATTR_MAX))  // = 0.0001
```

---

### 5.3 속성 보정 예제

#### 예제 1: 화 100 vs 풍 100 (유리)

```
공격자: 화 100, 기타 0
방어자: 풍 100, 기타 0

화_데미지 = 100 × 100 × 1.5 = 15,000
총합 = 15,000
속성_보정 = 15,000 × 0.0001 = 1.5

→ 데미지 ×1.5배
```

---

#### 예제 2: 화 100 vs 수 100 (불리)

```
공격자: 화 100, 기타 0
방어자: 수 100, 기타 0

화_데미지 = 100 × 100 × 0.6 = 6,000
총합 = 6,000
속성_보정 = 6,000 × 0.0001 = 0.6

→ 데미지 ×0.6배
```

---

#### 예제 3: 화 50 vs 풍 100 (절반)

```
공격자: 화 50, 기타 50
방어자: 풍 100, 기타 0

화_데미지 = 50 × 100 × 1.5 = 7,500
기타_데미지 = 50 × 100 × (상성)

속성_보정 ≈ 0.75 ~ 1.25

→ 속성이 절반이면 효과도 절반
```

---

## 6. 라이딩 펫 시스템

### 6.1 라이딩 펫이란?

캐릭터가 펫을 탑승하면 **캐릭터와 펫의 능력치가 합산**됩니다.

```c
// 소스 코드: gmsv/battle/battle_event.c:159-177
int BATTLE_getRidePet(int charaindex) {
    int rideIndex = CHAR_getInt(charaindex, CHAR_RIDEPET);
    if (rideIndex == -1) return -1;
    return CHAR_getCharPet(charaindex, rideIndex);
}
```

---

### 6.2 공격력 합산 (신규 버전)

#### 6.2.1 근접 무기 (검/도끼/주먹)

```c
// 소스 코드: gmsv/battle/battle_event.c:195-196
공격력 = (캐릭터_공격력 × 0.8) + (펫_공격력 × 0.8)
```

**예제**:
- 캐릭터 ATK = 1500
- 펫 ATK = 1000
- **라이딩 ATK = (1500×0.8) + (1000×0.8) = 2000**
- **증가율: 33.3%**

**특징**: 합산 비율 **160%** (80% + 80%)

---

#### 6.2.2 원거리 무기 (활/부메랑)

```c
// 소스 코드: gmsv/battle/battle_event.c:188-190 (신규)
공격력 = 캐릭터_공격력 + (펫_공격력 × 0.4)
```

**예제**:
- 캐릭터 ATK = 1500
- 펫 ATK = 1000
- **라이딩 ATK = 1500 + (1000×0.4) = 1900**
- **증가율: 26.7%**

**특징**: 합산 비율 **140%** (100% + 40%)

---

### 6.3 방어력 합산

**모든 무기/상황 공통**:

```c
// 소스 코드: gmsv/battle/battle_event.c:199-200
방어력 = (캐릭터_방어력 × 0.7) + (펫_방어력 × 0.7)
```

**예제**:
- 캐릭터 DEF = 840 (TGH 1200)
- 펫 DEF = 560 (TGH 800)
- **라이딩 DEF = (840×0.7) + (560×0.7) = 980**

**특징**: 합산 비율 **140%** (70% + 70%)

---

### 6.4 순발력 합산

#### 6.4.1 공격 시

**원거리 무기**:
```c
// 소스 코드: gmsv/battle/battle_event.c:205-206
순발력 = (캐릭터_순발력 × 0.8) + (펫_순발력 × 0.2)
```

**근접 무기** (신규):
```c
// 소스 코드: gmsv/battle/battle_event.c:209-210
순발력 = (캐릭터_순발력 × 0.2) + (펫_순발력 × 0.8)
```

---

#### 6.4.2 방어 시

**모든 무기 공통**:
```c
// 소스 코드: gmsv/battle/battle_event.c:219-220
순발력 = (캐릭터_순발력 × 0.1) + (펫_순발력 × 0.9)
```

**특징**: 방어 시 **펫의 순발력이 90%**

---

### 6.5 속성 합산 (신규 버전)

**중요**: 신규 버전에서는 **캐릭터 속성만 사용**합니다!

```c
// 소스 코드: gmsv/battle/battle_event.c:844-858
#ifdef _BATTLE_NEWPOWER
    // 신규: 캐릭터 속성만
    속성[화] = 캐릭터_화속성;
    속성[수] = 캐릭터_수속성;
    속성[지] = 캐릭터_지속성;
    속성[풍] = 캐릭터_풍속성;
#else
    // 구버전: 평균
    속성[화] = (캐릭터_화 + 펫_화) / 2;
    // ...
#endif
```

**핵심**: 펫의 속성은 **무시**됨!

---

### 6.6 라이딩 능력치 합산표 (신규 버전)

| 능력치 | 무기 종류 | 캐릭터 비율 | 펫 비율 | 합계 |
|---|---|:---:|:---:|:---:|
| **공격력** | 근접 | 80% | 80% | **160%** ✨ |
| **공격력** | 원거리 | 100% | 40% | **140%** |
| **방어력** | 공통 | 70% | 70% | **140%** |
| **순발력(공)** | 근접 | 20% | 80% | **100%** |
| **순발력(공)** | 원거리 | 80% | 20% | **100%** |
| **순발력(방)** | 공통 | 10% | 90% | **100%** |
| **속성** | 공통 | 100% | **0%** | **100%** |

---

## 7. 완전한 데미지 공식

### 7.1 전체 계산 흐름

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
단계 1: 라이딩 능력치 합산 (탑승 시만)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

if (라이딩 중):
    if (근접 무기):
        ATK = (캐릭ATK × 0.8) + (펫ATK × 0.8)
    else if (원거리 무기):
        ATK = 캐릭ATK + (펫ATK × 0.4)

    DEF = (캐릭DEF × 0.7) + (펫DEF × 0.7)
    속성 = 캐릭터_속성만
else:
    ATK = 캐릭터_공격력
    DEF = 캐릭터_방어력 × 0.7
    속성 = 캐릭터_속성

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
단계 2: 기본 데미지 계산
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

적_방어력 = 적_TGH × 0.7

if (ATK ≥ 적DEF × 1.14):
    base_damage = (ATK - 적DEF) ± (ATK × 6.25%)
else if (적DEF ≤ ATK < 적DEF × 1.14):
    base_damage = 0 ~ (ATK × 6.25%)
else:
    base_damage = 0 ~ 1

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
단계 3: 속성 보정 계산
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

각 속성별:
    속성_데미지 = 공격자_속성 × 방어자_속성 × 상성배율

속성_총합 = Σ(모든_속성_데미지)
속성_보정 = 속성_총합 × 0.0001

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
단계 4: 최종 데미지
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

final_damage = base_damage × 속성_보정
```

---

## 8. 실전 예제

### 8.1 비라이딩 전투

**캐릭터 A** (공격자):
- STR = 1500 → ATK = 1500
- 화 속성 10pt (100)

**몬스터 B** (방어자):
- TGH = 1200 → DEF = 840 (×0.7)
- 풍 속성 10pt (100)

---

#### 계산 과정

**1단계**: 라이딩 없음 → 능력치 그대로
```
ATK = 1500
적 DEF = 840
```

**2단계**: 기본 데미지
```
1500 ≥ 840 × 1.14 (957) → 케이스 1

base = (1500 - 840) = 660
랜덤 = ± (1500 × 6.25%) = ±93.75

평균 = 660
범위 = 566 ~ 754
```

**3단계**: 속성 보정 (화 vs 풍)
```
화_데미지 = 100 × 100 × 1.5 = 15,000
속성_보정 = 15,000 × 0.0001 = 1.5
```

**4단계**: 최종 데미지
```
final = 660 × 1.5 = 990
범위 = 849 ~ 1131
```

**결과**: 평균 **990** 데미지

---

### 8.2 라이딩 전투 (근접 무기)

**캐릭터 A** (공격자):
- STR = 1500 → ATK = 1500
- 화 속성 10pt (100)

**라이딩 펫**:
- STR = 1000 → ATK = 1000
- 지 속성 10pt (무시됨)

**몬스터 B** (방어자):
- TGH = 1200 → DEF = 840
- 풍 속성 10pt (100)

---

#### 계산 과정

**1단계**: 라이딩 능력치 합산 (근접)
```
ATK = (1500 × 0.8) + (1000 × 0.8)
    = 1200 + 800
    = 2000

속성 = 캐릭터만 = 화 100
```

**2단계**: 기본 데미지
```
2000 ≥ 840 × 1.14 (957) → 케이스 1

base = (2000 - 840) = 1160
랜덤 = ± (2000 × 6.25%) = ±125

평균 = 1160
```

**3단계**: 속성 보정 (화 vs 풍)
```
속성_보정 = 1.5 (동일)
```

**4단계**: 최종 데미지
```
final = 1160 × 1.5 = 1740
범위 = 1553 ~ 1928
```

**결과**: 평균 **1740** 데미지

**vs 비라이딩**: 1740 / 990 = **1.76배 증가!**

---

### 8.3 라이딩 전투 (원거리 무기)

**동일한 상황, 활 장착**

**1단계**: 라이딩 능력치 합산 (원거리)
```
ATK = 1500 + (1000 × 0.4)
    = 1500 + 400
    = 1900
```

**2단계**: 기본 데미지
```
base = (1900 - 840) = 1060
```

**3단계**: 속성 보정
```
속성_보정 = 1.5
```

**4단계**: 최종 데미지
```
final = 1060 × 1.5 = 1590
```

**결과**: 평균 **1590** 데미지

---

### 8.4 비교 요약

| 상황 | 공격력 | 기본 데미지 | 속성 보정 | 최종 데미지 | 비율 |
|---|:---:|:---:|:---:|:---:|:---:|
| **비라이딩** | 1500 | 660 | ×1.5 | **990** | 100% |
| **라이딩(근접)** | 2000 | 1160 | ×1.5 | **1740** | **176%** |
| **라이딩(원거리)** | 1900 | 1060 | ×1.5 | **1590** | **161%** |

**결론**: 근접 무기 라이딩이 **가장 강력!**

---

### 8.5 불리한 속성 예제

**공격자**: 풍 속성 100
**방어자**: 화 속성 100

**비라이딩**:
```
base = 660
속성_보정 = 0.6 (불리)
final = 660 × 0.6 = 396
```

**라이딩(근접)**:
```
base = 1160
속성_보정 = 0.6
final = 1160 × 0.6 = 696
```

**속성 차이**:
- 유리(1740) vs 불리(696) = **2.5배 차이!**

---

## 9. 최적화 전략

### 9.1 캐릭터 육성

#### 9.1.1 능력치 분배

**공격형 캐릭터**:
```
STR: 15~20pt (공격력 극대화)
TGH: 0~5pt (최소 생존)
DEX: 0~3pt (크리티컬용)
VIT: 0pt (신버전에서 효과 미미)
```

**방어형 캐릭터**:
```
TGH: 15~20pt (방어력 극대화)
STR: 0~5pt
DEX: 0~3pt
VIT: 0pt
```

**균형형**:
```
STR: 10pt
TGH: 10pt
DEX: 0pt
VIT: 0pt
```

---

#### 9.1.2 속성 선택

**공격 최적화**:
- **단일 속성 10pt**: 최대 효과 (×1.5 또는 ×0.6)
- 상대 주력 속성 파악 후 유리한 속성 선택

**예시**:
```
상대가 풍 속성 위주 → 화 속성 10pt 투자
상대가 무속성 위주 → 아무 속성이나 10pt 투자
```

**복합 속성은 비추천**:
- 5pt + 5pt = 각각 절반 효과
- 단일 10pt가 더 강력

---

### 9.2 라이딩 펫 선택

#### 9.2.1 근접 무기 사용 시

**최적 펫**:
```
STR 최대화 (공격력 80% 반영)
TGH 높은 펫 (방어력 70% 반영)
DEX 높은 펫 (방어 순발력 90%)
속성 무관 (캐릭터 속성만 적용)
```

**예시**: STR 1000, TGH 800 펫
```
공격력 기여 = 1000 × 0.8 = 800
방어력 기여 = 560 × 0.7 = 392
→ 강력한 전투력 증가
```

---

#### 9.2.2 원거리 무기 사용 시

**최적 펫**:
```
STR 높은 펫 (40% 반영)
캐릭터 DEX 중시 (순발력 80%)
```

**효율**:
- 근접 대비 공격력 증가 폭 낮음
- 순발력은 캐릭터 의존도 높음

---

### 9.3 무기 선택

**데미지 극대화**:
1. **근접 무기** (검/도끼/주먹)
   - 공격력 160% 합산
   - 펫 STR 80% 활용
   - **최고 데미지**

2. **원거리 무기** (활/부메랑)
   - 공격력 140% 합산
   - 안전 거리 확보
   - 순발력 의존

**추천**: 공격력 높은 펫 보유 시 **근접 무기**

---

### 9.4 전투 전략

#### 9.4.1 공격력 임계점

**목표**: 적 방어력의 **1.14배 이상** 확보

```
적 DEF = 840일 때
필요 ATK = 840 × 1.14 = 957 이상

→ 957 미만: 약한 데미지 (0~60)
→ 957 이상: 강한 데미지 (base = ATK-DEF)
```

**전략**:
- 임계점 넘기면 데미지 폭발적 증가
- 장비/버프로 임계점 돌파

---

#### 9.4.2 속성 활용

**상대 속성 파악**:
```
적이 풍 속성 → 화 속성 공격 (×1.5)
적이 화 속성 → 수 속성 공격 (×1.5)
적이 수 속성 → 지 속성 공격 (×1.5)
적이 지 속성 → 풍 속성 공격 (×1.5)
적이 무속성 → 아무 속성 (×1.5)
```

**속성 캐릭터 복수 육성**:
- 4속성 캐릭터 각 1명씩
- 상황에 맞게 선택

---

#### 9.4.3 펫 전략

**펫 육성 우선순위**:
1. **공격형 펫**: STR 극대화
2. **방어형 펫**: TGH, DEX 극대화
3. 속성은 무시 (신버전)

**펫 교체 전략**:
- 공격 시: STR 높은 펫
- 방어 시: DEX 높은 펫 (순발력 90%)

---

### 9.5 최대 데미지 달성법

**조건**:
1. ✅ 캐릭터 STR 최대 (1500+)
2. ✅ 펫 STR 최대 (1000+)
3. ✅ 근접 무기 장착
4. ✅ 유리한 속성 상성
5. ✅ 적 방어력 × 1.14 이상 ATK

**결과**:
```
ATK = (1500×0.8) + (1000×0.8) = 2000
적 DEF = 840
base = 2000 - 840 = 1160
속성 = ×1.5
final = 1160 × 1.5 = 1740

vs 비라이딩 (990)
→ 75% 증가!

vs 불리한 속성 (396)
→ 339% 증가!
```

---

## 10. 부록

### 10.1 주요 상수 정리

```c
// 속성 상성
#define AJ_SAME  (1.0)   // 동일 속성
#define AJ_UP    (1.5)   // 유리한 속성
#define AJ_DOWN  (0.6)   // 불리한 속성

// 속성 계산
#define ATTR_MAX 100
#define D_ATTR (1.0/(ATTR_MAX*ATTR_MAX))  // 0.0001

// 데미지 계산
#define D_8  (1.0/8.0)   // 0.125
#define D_16 (1.0/16.0)  // 0.0625

// 방어력 비율 (신버전)
방어력 = TGH × 0.70
```

---

### 10.2 소스 코드 위치

| 기능 | 파일 | 라인 |
|---|---|---|
| 캐릭터 생성 | gmsv/char/char.c | 133-141 |
| 전투 능력치 변환 | gmsv/battle/battle.c | 2712-2727 |
| BATTLE_TurnParam | gmsv/battle/battle.c | 2624-2650 |
| 기본 데미지 계산 | gmsv/battle/battle_event.c | 1041-1134 |
| 속성 상성 상수 | gmsv/battle/battle_event.c | 25-31 |
| 속성 데미지 계산 | gmsv/battle/battle_event.c | 795-1011 |
| 라이딩 공격력 | gmsv/battle/battle_event.c | 180-230 |
| 라이딩 속성 | gmsv/battle/battle_event.c | 842-899 |

---

### 10.3 버전 플래그

**신규 버전 확인**:
```c
#ifdef _BATTLE_NEWPOWER
    // 신규 버전 코드
#else
    // 구버전 코드
#endif
```

**주요 차이**:
- 방어력: 신규 70%, 구버전 복합
- 원거리 공격: 신규 40%, 구버전 20%
- 라이딩 속성: 신규 캐릭터만, 구버전 평균

---

### 10.4 계산기 예제 코드

```python
# 파이썬으로 데미지 계산하기

def calculate_damage(char_atk, char_def, char_attr,
                     enemy_def, enemy_attr,
                     riding_pet_atk=0, weapon_type='melee'):
    """
    석기시대 데미지 계산기

    char_atk: 캐릭터 공격력
    char_def: 캐릭터 방어력
    char_attr: 캐릭터 속성 [화,수,지,풍]
    enemy_def: 적 방어력
    enemy_attr: 적 속성 [화,수,지,풍]
    riding_pet_atk: 라이딩 펫 공격력 (0=비라이딩)
    weapon_type: 'melee' 또는 'ranged'
    """

    # 1단계: 라이딩 공격력 합산
    if riding_pet_atk > 0:
        if weapon_type == 'melee':
            atk = (char_atk * 0.8) + (riding_pet_atk * 0.8)
        else:  # ranged
            atk = char_atk + (riding_pet_atk * 0.4)
    else:
        atk = char_atk

    # 2단계: 방어력 계산
    defense = enemy_def * 0.7

    # 3단계: 기본 데미지
    if atk >= defense * 1.14:
        base_damage = atk - defense
    elif atk >= defense:
        base_damage = atk * 0.0625  # 평균값
    else:
        base_damage = 0.5

    # 4단계: 속성 보정
    attr_bonus = calculate_attr_bonus(char_attr, enemy_attr)

    # 5단계: 최종 데미지
    final_damage = base_damage * attr_bonus

    return int(final_damage)


def calculate_attr_bonus(char_attr, enemy_attr):
    """속성 보정 계산"""
    # char_attr, enemy_attr: [화,수,지,풍] 배열

    # 속성 상성표
    attr_table = [
        [1.0, 0.6, 1.0, 1.5],  # 화 vs [화,수,지,풍]
        [1.5, 1.0, 0.6, 1.0],  # 수 vs [화,수,지,풍]
        [1.0, 1.5, 1.0, 0.6],  # 지 vs [화,수,지,풍]
        [0.6, 1.0, 1.5, 1.0],  # 풍 vs [화,수,지,풍]
    ]

    # 무속성 계산
    char_none = 100 - sum(char_attr)
    enemy_none = 100 - sum(enemy_attr)

    total = 0
    for i in range(4):
        for j in range(4):
            total += char_attr[i] * enemy_attr[j] * attr_table[i][j]
        # vs 무속성
        total += char_attr[i] * enemy_none * 1.5

    # 무속성 vs 적
    for j in range(4):
        total += char_none * enemy_attr[j] * 0.6
    total += char_none * enemy_none * 1.0

    return total * 0.0001


# 사용 예제
damage = calculate_damage(
    char_atk=1500,
    char_def=840,
    char_attr=[100, 0, 0, 0],  # 화 100
    enemy_def=840,
    enemy_attr=[0, 0, 0, 100],  # 풍 100
    riding_pet_atk=1000,
    weapon_type='melee'
)
print(f"데미지: {damage}")  # 출력: 데미지: 1740
```

---

## 마치며

이 가이드는 석기시대 2.5 서버의 **신규 버전 (`_BATTLE_NEWPOWER` 활성화)** 기준으로 작성되었습니다.

**핵심 요약**:
1. 공격력 = STR (거의 그대로)
2. 방어력 = TGH × 0.7
3. 속성 상성 = ×1.5 (유리) / ×0.6 (불리)
4. 라이딩 근접 = 160% 공격력
5. 임계점 = 방어력 × 1.14

**최강 조합**:
- STR 극대화 + 공격펫 + 근접무기 + 유리한속성
- → **비라이딩 대비 1.75배 이상 데미지!**

---

**분석 날짜**: 2025-01-03
**분석자**: AI Assistant
**소스**: https://github.com/gavinlinasd/StoneAge
